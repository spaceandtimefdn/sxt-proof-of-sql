// SPDX-License-Identifier: UNLICENSED
// This is licensed under the Cryptographic Open Software License 1.0
pragma solidity ^0.8.26;

import {Test} from "forge-std/Test.sol";
import "../../src/base/Constants.sol";
import {VerificationBuilder} from "../../src/builder/VerificationBuilder.presl";
import {ProjectionExec} from "../../src/proof_plans/ProjectionExec.presl";

contract ProjectionExecTest is Test {
    function testSimpleProjectionExec() public pure {
        bytes memory plan = abi.encodePacked(
            TABLE_EXEC_VARIANT,
            uint64(0), // table_number
            uint64(2), // column_count
            uint64(0), // column0_index
            uint64(1), // column1_index
            uint64(1), // results
            COLUMN_EXPR_VARIANT,
            uint64(0),
            hex"abcdef"
        );

        VerificationBuilder.Builder memory builder;

        // column evaluations
        builder.columnEvaluations = new uint256[](2);
        uint256[4] memory column0 = [uint256(1), 3, MODULUS_MINUS_ONE, 400];
        uint256[4] memory column1 = [uint256(1), 0, 0, 1];

        // chi evals
        builder.tableChiEvaluations = new uint256[](2);
        builder.tableChiEvaluations[0] = 4;
        builder.tableChiEvaluations[1] = 1;

        // max degree and row multipliers
        builder.maxDegree = 3;
        builder.rowMultipliersEvaluation = 1;

        builder.aggregateEvaluation = 0;

        for (uint8 i = 0; i < 4; ++i) {
            bytes memory planOutput;
            uint256[] memory evals;
            uint256 outputChiEval;
            uint256 length;
            builder.columnEvaluations[0] = column0[i];
            builder.columnEvaluations[1] = column1[i];
            (planOutput, builder, evals, length, outputChiEval) = ProjectionExec.__projectionExecEvaluate(plan, builder);
            assert(planOutput.length == 3);
        }

        assert(builder.aggregateEvaluation == 0);
    }
}
