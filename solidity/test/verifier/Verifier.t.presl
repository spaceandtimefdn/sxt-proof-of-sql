// SPDX-License-Identifier: UNLICENSED
// This is licensed under the Cryptographic Open Software License 1.0
pragma solidity ^0.8.28;

import {Test} from "forge-std/Test.sol";
import "./../../src/base/Constants.sol";
import {Errors} from "./../../src/base/Errors.sol";
import {Verifier} from "./../../src/verifier/Verifier.presl";

contract VerifierTest is Test {
    function verify(
        bytes calldata result,
        bytes calldata plan,
        uint256[] calldata placeholderParameters,
        bytes calldata proof,
        uint256[] memory tableLengths,
        uint256[] memory commitments
    ) public view {
        Verifier.__internalVerify({
            __result: result,
            __plan: plan,
            __placeholderParameters: placeholderParameters,
            __proof: proof,
            __tableLengths: tableLengths,
            __commitments: commitments
        });
    }

    // Test a simple filter query using __internalVerify (commitments passed directly)
    //
    // SQL: SELECT b FROM namespace.table WHERE a = 5
    //
    // Table data (6 rows, columns a and b are BigInt):
    //   | a | b |
    //   |---|---|
    //   | 5 | 0 |
    //   | 1 | 1 |
    //   | 2 | 2 |
    //   | 5 | 3 |
    //   | 4 | 4 |
    //   | 3 | 5 |
    //
    // Expected result (2 rows where a = 5):
    //   | b |
    //   |---|
    //   | 0 |
    //   | 3 |
    function testSimpleFull() public view {
        uint256[] memory tableLengths = new uint256[](1);
        tableLengths[0] = 6;
        uint256[] memory commitments = new uint256[](4);
        commitments[0] = 11994260765248910561540716452031502208136256599213361935879450273410509855704;
        commitments[1] = 13760418268827664034425846360177624835399216842325030254024970295997593510876;
        commitments[2] = 10330259091102222580680469239495014349163118537637164875615751892418606990939;
        commitments[3] = 11920476268597659993223945595713248355766624440856258163660132291159882440306;
        uint256[] memory placeholderParameters = new uint256[](0);
        Verifier.__internalVerify({
            __result: hex"00000000000000010000000000000001620000000005000000000000000200000000000000000000000000000003",
            __plan: hex"0000000000000001000000000000000f6e616d6573706163652e7461626c65000000000000000200000000000000000000000000000001610000000500000000000000000000000000000001620000000500000000000000010000000000000001620000000600000001000000000000000000000000000000020000000000000000000000000000000100000002000000000000000000000000000000010000000500000000000000050000000000000001000000000000000000000001",
            __placeholderParameters: placeholderParameters,
            __proof: hex"000000000000000600000000000000020000000000000001000000000000000200000000000000000000000000000001236cd1dd5ae57dd08a8b09bd6bd3397fe4b58aa1638c554b8054dcb2d4d0297e12a7e3d2a6d11cf4e66979ea5458d24f66ba7866c43b933fd2135c2a761990140000000000000006000000000000000427a607595971e4f8531109d6bcf114838faac36652aa81d86d51f087cd08799c1095fa761ceaceb796068f4b8174492ede1e88c2f4aafee493331c267284be330078dfd5227feba93faa9a0c9c38432d6c169909d2546f8cef0b7a2108d44db71d518c19207b5ee92cca5cfe09ec5aca67af638b4205a7b650ccb9b9ecd6dd8100a79a224c12853378f4ddf8861e97d07054fb47ab0aa6750f99358df280b5a522a3beed1469294cd611934dac07c366dd0d8d334355c9d0b4ffb0c082b239ef21769956826ee475eb9b247cf1d7a752843c1b7fa0eebf7057e0c5701beae9402ca3c2daa92ab61d0b296480d2f344808a15672bd39ff95acd287ba0d98477b90000000000000000000000000000000c11266c57ff60eccf0296bf81abdec9f30413d402284ec2435076a15851228bb22f94e12575a52eab3f5406d1436c403723ee835a360c36072dc263848101320c200d4f684d5d24d92eb5c51a13b7a690286579349517e8d8098ae64b0ddc42440000000000000000000000000000000000000000000000000000000000000000003e35bdd48fb6aadefa228e22c6838d294c83648829df30ceeb884142985b3d1d0797d27ab8b5078721184ab78a735af471ad665ec5f72dcce7db2aaa56ae402d4794232f168a0bb42b942f816af03740a970ddbcd9709043a7daec15aaa2ed1173e6820b1576b1406043b3dee7f502c9df727e0f00e33a1d104801dc28b0f32576f07276feecc04e290341f18221336642ffe5f16c03a5f2ef2505125cc3d11219eb0c91f2d809484e2d8ddbbc3385ad1e828b2d1cd04ec4df20c104d8906209d88d95424af06ad25e914abbca418ad16a2759d38de6e8460e1a613ad7fe611e505a7804ecc4f2fdbde2bbb1287480d1e1f2c8c231b1ab40928a1f5f58063d00000000000000010b66572ca605dcb9e0ebde29266d3de7123074e8e6b1502bab364da9b5b16e4d00000000000000020f32b0f5364c733340c8001017616c17ea1329282f2a1c28780d2788c5928d0402e6371de47b7af8fa71f458bbe36aafd47f4c0da92601c0e359c8cd38181a9d0000000000000004136411985d52ac6e72aca4f5465652c856f2d421923ec27e1c98122af8273cec10a15c041a9bc5ecd81a519ea5946748f5833ebb6d61d8825ff252fe214c654f0e68a3291dc72259512e9f0fa1e49f3f2057b2caa02d5c8b05bad5b83623ef852c449fec1d383ecd3e03696c91e71acd1260ab2a33541b565138039e663180d800000000000000020f6bc3964689999bf78cce15c87baccf4c3be3f6d75ff1d6db04816a46ab29ed180c101098ccd7e40158c5d8906c8790514c850cb07a34adde73a2528804e8731813c32da09c97d7d7b9b67553f737706f0bc851f6039cb80e2887d0aa0db560247cee3fab89b8e0e3c38e82fea7c871e39e3967a2fc0685ebac531a5c0838fc0000000000000003075261379757ac740d9a7f5f62a900d7d5b133d145650e4567f10d21ef7e83a2251f221db84c4a524f3d8c0a4acf2f7854f7a18fc871642de0dc363ccc648c1617dc6537f97533589138ebbded223c6c0b4e9505c0d8e62034e00facd32bb0631ad19e9b640d66408fac0fbc9c6c0574a20222c38ebea06136f0c90f677781151459b46f6f1d5c244239d4b2a9cf02bc8a1084a78c047fe7e1c2b6c81a3c61381d06d7b13698806b1428749ba672e822e820cf792950d57e291ee4c756316a2b2caaaabc8b60c422bb0252e595d0cae8aa120d8b253b413411d7567faae65bc90990c8b1639a471e03b983388249820ff89b23336ef85f84d6b59f9f5cc13c400176252750f541f13bd7193edee5545a1cc88426057a9d7d51a92ecb05c34046222a3b39097a1f62793d1ef01cc5582ae25641e5e0a851a7902b33848133febe142ad6a164d09c07961bba6b67870a1a8c09ed2ca6cc736ff6ee1c7f8e202da5281f6790b8cabb63d60179581e19ca38883d1daac86d483b36369e3132f2e812163cb630d105395bc2a2b13b18546372b555f05fd78cf80b003c06fdebfe305c1fe799e533660e97bf79ea84361b3090ebace0fd582b8b2e1611f87d07c9941c0609e0bbdac0ee68b8b386b240800d976316c31385cd58f6fa4daef92a5c1ffe",
            __tableLengths: tableLengths,
            __commitments: commitments
        });
    }

    // Test an aggregate query with filter using __internalVerify
    //
    // SQL: SELECT sum(b) as sum_b, count(*) as count_0 FROM namespace.table WHERE c = 2
    //
    // Table data (5 rows, columns b and c are BigInt):
    //   | b | c |
    //   |---|---|
    //   | 0 | 2 |
    //   | 1 | 3 |
    //   | 2 | 2 |
    //   | 3 | 1 |
    //   | 5 | 2 |
    //
    // Expected result (aggregation over 3 rows where c = 2):
    //   | sum_b | count_0 |
    //   |-------|---------|
    //   |   7   |    3    |
    //
    // Note: sum_b = 0 + 2 + 5 = 7, count_0 = 3 rows match
    function testZeroColumnGroupByFull() public view {
        uint256[] memory tableLengths = new uint256[](1);
        tableLengths[0] = 5;
        uint256[] memory commitments = new uint256[](4);
        commitments[0] = 19765720492177419963788694737791439009069442955958503266527277086296650685213;
        commitments[1] = 16205954246860985972455580111210435693775243641116428273155181252052701609719;
        commitments[2] = 21102000546357085508238449036378589776438325588129596676953259782322424000430;
        commitments[3] = 4228521887420592540390008097559034817710337265066472461729050970149453020647;
        uint256[] memory placeholderParameters = new uint256[](0);
        Verifier.__internalVerify({
            __result: hex"0000000000000002000000000000000573756d5f62000000000a000000000000000100000000000000000000000000000000000000000000000000000000000000070000000000000007636f756e745f30000000000500000000000000010000000000000003",
            __plan: hex"0000000000000001000000000000000f6e616d6573706163652e7461626c6500000000000000020000000000000000000000000000000162000000050000000000000000000000000000000163000000050000000000000002000000000000000573756d5f620000000000000007636f756e745f3000000002000000020000000700000006000000010000000000000000000000000000000200000000000000000000000000000001000000020000000000000000000000010000000100000005000000000000000200000000000000010000000000000000000000000000000000000000000000010000000001000000000000000100000000000000000000000000000000000000013100000000000000020000000000000000000000000000000000000000000000010000000000000002000000000000000000000000000000000000000000000001",
            __placeholderParameters: placeholderParameters,
            __proof: hex"000000000000000500000000000000040000000000000002000000000000000300000000000000010000000000000000000000000000000325f5958d061ca6ac59f7729bbfbc851ad6d42235c02e8c896809580b011c6c150f1c7197bc1fefdd6e34b25520c69786bc3f154866d0360e1360087f69c8271b17072b2ed3bb8d759a5325f477629386cb6fc6ecb801bd76983a6b86abffe078168ada6cd130dd52017bb54bfa19377aadfe3bf05d18f41b77809f7f60d4af9e0769bf9ac56bea3ff40232bcb1b6bd159315d84715b8e679f2d355961915abf02ab799bee0489429554fdb7c8d086475319e63b40b9c5b57cdf1ff3dd9fe2261000000000000000900000000000000061ae01df3cca8bea7717e246e93d8b0dc4a822f059cfb0edd95b312a028262cc80472b4855a09cbeb89d9829e46e26c30da05435f2460bb7f0074020ae5083b70211fbdd5be5f9660c7b02fea419ae3b9753c4b3036b7e68924453a26c309f58b04fed641c12f56b264eb2b8fce97a014e6b1f3fc830c63b25506bdd2ce2289242e936b587be3b89c2f2b1c49be589bbfb6c087550674c1c83208839ae3d7d2c123d77379fd01a706e6373012ab6abbb7fe226c6252a50c8b7ebe57bf819f9f4124c37720c3c35bd179b5bc7276d5cbdec9130b7c9ad4f070bc0f939052d3ee6900d90eb6ba5e723d6a3304ea3f00458ab9491ad0d99d5cb01f52210c25098c242cedc2c3c9f37fde73d73490e42421a6cd87d34130429670f8416bd846a13622014e83c22e6fa3bdcb50e29407dbe90b68cb03a4de43c2cb206cfc369cf8d5ca000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000c26da13b0e0048098b8c715d5b4b4d93ade78cf3b7fbf3083c7c6335da8779ec625f4bece097d7be31a6c5da786944bf298ed9e74bffbad0a40ca59b6fcac473126411a9410a4afbaf2b01667c6dc7ce2dd6c62acd565198894a365656a13ad6c0f0e7f22d4b71a233186a39f412f338391e4743e2c062d4e9738f720e06436502c8867dea03f32fc45c3491bb67fc7209abcd08af75f85936aa67f0f5f75e6820564adfc4889d1765b7c37f8e0d460cd958aafffe34edbfc286469306adb004e08a6da935ed1a4ee8b5dbb0d55c7dd5ce3db3b8a1e83dcd73416fd4f79ac553509c4f2debc61415963c2dec93734de56e96852c4ae97cba3f6e9159b058e698a2b6883246313333a8205e1aab2bd699fb49930e1769f142f632d4aa20fe6f7c3294221bb548eac10ffc33b3b44c21e04bc2cfce30b7ebea9c6993e3dfc17d48818a1d4b8aa768bc1b1712b6adef2aa85d5a7c1464be9b9c41398418cc2ee94a5088dc00f6028e343a4885dfa1638d4c22a4a0c6e7bdf10946c00eab6f7b6755a00000000000000031fed781c6dce5b5e7ccd6d8a06f5951fd4b8c0b1ccb301bd5325e5e99ed81a552c9de4d78881767f8dbbd8f7ebe20639c8481632baae2cc839ca1871e268258b054b94cdd59705062ca74911893be96bdca2596ebf8360be97a85698d35134a9000000000000000215506d10ff2247b0c7021d22327580d84eac8104aad9613347efaa664d29d86d0b1c89648c93835f71e808fcdf9c5dae26abc98327e1e8a2bd20e5f63275fc6f0000000000000006175369922e7d426429189ab415496b6fbc5fbb56deb330c7dad0c8c0304b06c90da094ad9c90d5f42c879220106d1b502b39a13033c60b63bd9eb4c64451f0aa0710b912fbea1a121d53c0d4941a5af78f24f65112aa7cdafb5880258e6b28a01b0870aea1fb904d25746cd1081191762b11b99c26d97ff10bb515c5c174ca0005c26d0eda279fdd0ebadf35513c4bcfa7590125aa3c364c0eab6747608d16df2206bb3bdd536c73346d46d4d96a33620f0363553ba76b4b0a796b403bc5bc39000000000000000216a7d656b184faeb6edee708bbda681918231b12a0b005d903d2391774cd0ba52edf243f71f51f3a2e42955885ccdcac3cbcb48e78e64366497b9ccb05ad728c11d8a94893b73a54f667f94515ef566b76cce6547452d48cb7a991e836e9f898000ee830dad187d57cc6961c0435909f6d32f625362ff0934383d69e5b7dccba0000000000000003283d301832cc257083dbd02561d6bcf6a971488af5b346c1e0516a2057593dd907200a52b447a94d6cd9d1ddfd116f112f164500b0714048a44c5f71a4ce03de0aaf29eafab1f8d8ceed143c8531784641f4a941f5f67625ae46343bfe94c25521514ecda40ee5dcd2903ecb0975ce4bcc66bc97e422d2d5b9b76bc88e05ea60020e59f029a46d3f9c98ec2ee4083702d0239833e061c358841bdb969a6cf49b26c33e3627a522f96e8e2157e69a5c6c88fd3a7e533a665fedf36f5afb0ff021090e9d77435194b09ef1d1df02e7cbec98bc3eedaeecbf3f7a0016cca3347ea820013e7fff3fa2cca30d2d5a8e3dbf9195cefd6a4af144f80d4b0a97ef1aa8e01dd8f9d87e9253b2a5075ed7a25f5947c17b69928e2602164cf96be0971b82551f2dc86fc66ab810a93c58b40e5692bfdffd02304e33b2b9073d679beb311bcd1e05bb20425b214075b607066643eec16ca4ae867270963437cea1c9923f58572cd6138f439cf99230e8306c2d9383b3d4917fa0247e3953bd0e08b7fcf7f0e817f8f7db125e6965b4ea8c7f8b5b07326b65dfd032a3a4563f321c05ac704158095acc17439774aa9d7d456eb8bdfa3c9127c8cf4d366fe4961975119987288607307ae974350dd2d16ab798d41cfe18117b476e732fa97b3e5fefcfb703c2b4",
            __tableLengths: tableLengths,
            __commitments: commitments
        });
    }

    function testCommitmentArrayOddLength() public {
        uint256[] memory tableLengths = new uint256[](1);
        tableLengths[0] = 6;

        // Create an array with an odd length (5 elements)
        uint256[] memory commitments = new uint256[](5);
        commitments[0] = 10330259091102222580680469239495014349163118537637164875615751892418606990939;
        commitments[1] = 11920476268597659993223945595713248355766624440856258163660132291159882440306;
        commitments[2] = 11994260765248910561540716452031502208136256599213361935879450273410509855704;
        commitments[3] = 13760418268827664034425846360177624835399216842325030254024970295997593510876;
        commitments[4] = 12345678901234567890123456789012345678901234567890123456789012345678901234567; // Add extra element

        uint256[] memory placeholderParameters = new uint256[](0);

        // Expect the error for odd-length commitment array
        vm.expectRevert(Errors.CommitmentArrayOddLength.selector);

        Verifier.__internalVerify({
            __result: hex"00",
            __plan: hex"00",
            __placeholderParameters: placeholderParameters,
            __proof: hex"00",
            __tableLengths: tableLengths,
            __commitments: commitments
        });
    }

    // Test the same filter query as testSimpleFull but using the high-level verify() function
    // which accepts serialized tableCommitments instead of raw commitment arrays.
    //
    // SQL: SELECT b FROM namespace.table WHERE a = 5
    //
    // Table data (6 rows, columns a and b are BigInt):
    //   | a | b |
    //   |---|---|
    //   | 5 | 0 |
    //   | 1 | 1 |
    //   | 2 | 2 |
    //   | 5 | 3 |
    //   | 4 | 4 |
    //   | 3 | 5 |
    //
    // Expected result (2 rows where a = 5):
    //   | b |
    //   |---|
    //   | 0 |
    //   | 3 |
    //
    // Note: This test exercises the tableCommitments deserialization path
    function testVerify() public view {
        bytes[] memory tableCommitments = new bytes[](1);
        tableCommitments[0] =
            hex"0000000000000000000000000000000600000000000000021a8482d208bad3eeadc836daec1e6bba51ccbc58387b4457d2175934a8fa5bd81e6c1ee8c9a4d39fe271abfb51d3662d199fe6856ded86f727174dbe21ab63dc16d6b82d96cfec48a1c026598f99bbf3c07ca111e6eb2a9c4e2e9187827d065b1a5ac01ef230e94760b6ad505b9a00be520384bc89cb0e72260135c637679e7200000000000000020000000000000001610000000005000000050000000180000000000000007fffffffffffffff0000000000000001620000000005000000050000000180000000000000007fffffffffffffff";
        bytes memory queryPlan =
            hex"0000000000000001000000000000000f6e616d6573706163652e7461626c65000000000000000200000000000000000000000000000001610000000500000000000000000000000000000001620000000500000000000000010000000000000001620000000600000001000000000000000000000000000000020000000000000000000000000000000100000002000000000000000000000000000000010000000500000000000000050000000000000001000000000000000000000001";

        Verifier.verify({
            __result: hex"00000000000000010000000000000001620000000005000000000000000200000000000000000000000000000003",
            __plan: queryPlan,
            __placeholderParameters: new uint256[](0),
            __proof: hex"000000000000000600000000000000020000000000000001000000000000000200000000000000000000000000000001236cd1dd5ae57dd08a8b09bd6bd3397fe4b58aa1638c554b8054dcb2d4d0297e12a7e3d2a6d11cf4e66979ea5458d24f66ba7866c43b933fd2135c2a761990140000000000000006000000000000000427a607595971e4f8531109d6bcf114838faac36652aa81d86d51f087cd08799c1095fa761ceaceb796068f4b8174492ede1e88c2f4aafee493331c267284be330078dfd5227feba93faa9a0c9c38432d6c169909d2546f8cef0b7a2108d44db71d518c19207b5ee92cca5cfe09ec5aca67af638b4205a7b650ccb9b9ecd6dd8100a79a224c12853378f4ddf8861e97d07054fb47ab0aa6750f99358df280b5a522a3beed1469294cd611934dac07c366dd0d8d334355c9d0b4ffb0c082b239ef21769956826ee475eb9b247cf1d7a752843c1b7fa0eebf7057e0c5701beae9402ca3c2daa92ab61d0b296480d2f344808a15672bd39ff95acd287ba0d98477b90000000000000000000000000000000c11266c57ff60eccf0296bf81abdec9f30413d402284ec2435076a15851228bb22f94e12575a52eab3f5406d1436c403723ee835a360c36072dc263848101320c200d4f684d5d24d92eb5c51a13b7a690286579349517e8d8098ae64b0ddc42440000000000000000000000000000000000000000000000000000000000000000003e35bdd48fb6aadefa228e22c6838d294c83648829df30ceeb884142985b3d1d0797d27ab8b5078721184ab78a735af471ad665ec5f72dcce7db2aaa56ae402d4794232f168a0bb42b942f816af03740a970ddbcd9709043a7daec15aaa2ed1173e6820b1576b1406043b3dee7f502c9df727e0f00e33a1d104801dc28b0f32576f07276feecc04e290341f18221336642ffe5f16c03a5f2ef2505125cc3d11219eb0c91f2d809484e2d8ddbbc3385ad1e828b2d1cd04ec4df20c104d8906209d88d95424af06ad25e914abbca418ad16a2759d38de6e8460e1a613ad7fe611e505a7804ecc4f2fdbde2bbb1287480d1e1f2c8c231b1ab40928a1f5f58063d00000000000000010b66572ca605dcb9e0ebde29266d3de7123074e8e6b1502bab364da9b5b16e4d00000000000000020f32b0f5364c733340c8001017616c17ea1329282f2a1c28780d2788c5928d0402e6371de47b7af8fa71f458bbe36aafd47f4c0da92601c0e359c8cd38181a9d0000000000000004136411985d52ac6e72aca4f5465652c856f2d421923ec27e1c98122af8273cec10a15c041a9bc5ecd81a519ea5946748f5833ebb6d61d8825ff252fe214c654f0e68a3291dc72259512e9f0fa1e49f3f2057b2caa02d5c8b05bad5b83623ef852c449fec1d383ecd3e03696c91e71acd1260ab2a33541b565138039e663180d800000000000000020f6bc3964689999bf78cce15c87baccf4c3be3f6d75ff1d6db04816a46ab29ed180c101098ccd7e40158c5d8906c8790514c850cb07a34adde73a2528804e8731813c32da09c97d7d7b9b67553f737706f0bc851f6039cb80e2887d0aa0db560247cee3fab89b8e0e3c38e82fea7c871e39e3967a2fc0685ebac531a5c0838fc0000000000000003075261379757ac740d9a7f5f62a900d7d5b133d145650e4567f10d21ef7e83a2251f221db84c4a524f3d8c0a4acf2f7854f7a18fc871642de0dc363ccc648c1617dc6537f97533589138ebbded223c6c0b4e9505c0d8e62034e00facd32bb0631ad19e9b640d66408fac0fbc9c6c0574a20222c38ebea06136f0c90f677781151459b46f6f1d5c244239d4b2a9cf02bc8a1084a78c047fe7e1c2b6c81a3c61381d06d7b13698806b1428749ba672e822e820cf792950d57e291ee4c756316a2b2caaaabc8b60c422bb0252e595d0cae8aa120d8b253b413411d7567faae65bc90990c8b1639a471e03b983388249820ff89b23336ef85f84d6b59f9f5cc13c400176252750f541f13bd7193edee5545a1cc88426057a9d7d51a92ecb05c34046222a3b39097a1f62793d1ef01cc5582ae25641e5e0a851a7902b33848133febe142ad6a164d09c07961bba6b67870a1a8c09ed2ca6cc736ff6ee1c7f8e202da5281f6790b8cabb63d60179581e19ca38883d1daac86d483b36369e3132f2e812163cb630d105395bc2a2b13b18546372b555f05fd78cf80b003c06fdebfe305c1fe799e533660e97bf79ea84361b3090ebace0fd582b8b2e1611f87d07c9941c0609e0bbdac0ee68b8b386b240800d976316c31385cd58f6fa4daef92a5c1ffe",
            __tableCommitments: tableCommitments
        });
    }

    function testDeserializeTableCommitment() public pure {
        bytes[] memory tableCommitments = new bytes[](1);
        tableCommitments[0] =
            hex"00000000000000000000000000000003000000000000000a28b9628e4dd40477d8b9c22553ab1cef7de92be01aa635272a5153fdcc667a3c283fc7f7405e8f20c65e94abcfaddc18fb6d6d5fd6f24126a55fd428dc700b9028be5523f6dbeba579ba197a7c1f4f03f46da1dae8ea2e49527194195818f6680238e6a4be9f9fc58f0fe9a6d2ac32e2f357de9f33867506bcc8867695fcd8522699c20d6b46ccff9aea7842e64fccb91f59bd19b41ae4e4d29dee4804838ae0128ee7a84902f933505672b38340d2cdabeeca5c0c76e5548398ed95cdc8384c2fc17fec090794eae15adf182c461cad4867eab5807d4f38c86952472960e1d60ad5cb46df983be9f745caa334c85de105e9718c88205188939729b1794ea8de257aad035de6dc285d1be01072947fb3bbff4b71457613d266dbde54710e52dd0e5bab33d51316dd8f77fcd732e259fb1599aaefd7d55c59c63fe81bdf030ca2257aad035de6dc285d1be01072947fb3bbff4b71457613d266dbde54710e52dd0e5bab33d51316dd8f77fcd732e259fb1599aaefd7d55c59c63fe81bdf030ca2257aad035de6dc285d1be01072947fb3bbff4b71457613d266dbde54710e52dd0e5bab33d51316dd8f77fcd732e259fb1599aaefd7d55c59c63fe81bdf030ca216650968b1ec0b8cd847a81234cb55453682b378aba2b9ee1124232fab5f2e082ad3e1cb2fc5c73829abfe1aca3cbc9787c9bdccc3f698d4acd55b7f6d70ed07257aad035de6dc285d1be01072947fb3bbff4b71457613d266dbde54710e52dd0e5bab33d51316dd8f77fcd732e259fb1599aaefd7d55c59c63fe81bdf030ca2257aad035de6dc285d1be01072947fb3bbff4b71457613d266dbde54710e52dd0e5bab33d51316dd8f77fcd732e259fb1599aaefd7d55c59c63fe81bdf030ca2000000000000000a00000000000000016100000000000000000000000000000000016200000000020000000200000002fe0200000000000000016300000000030000000300000002fc18000e00000000000000016400000000040000000400000002fffffffe000f42400000000000000001650000000005000000050000000200000000000000010000000000000003000000000000000166000000000700000000000000000000000167000000000808010000000000000000000000016800000000090000000100000000000000070000000200000000000000010000000000000005000000000000000169000000000a0000000000000000000000016a000000000b00000000";
        Verifier.TableCommitment memory deserializedTableCommitment =
            VerifierTestWrapper.deserializeTableCommitments(tableCommitments)[0];
        assert(deserializedTableCommitment.tableLength == 3);
        bytes32[] memory expectedColumnHashes = new bytes32[](10);
        expectedColumnHashes[0] = keccak256(bytes("a")); // Boolean
        expectedColumnHashes[1] = keccak256(bytes("b")); // TinyInt
        expectedColumnHashes[2] = keccak256(bytes("c")); // SmallInt
        expectedColumnHashes[3] = keccak256(bytes("d")); // Int
        expectedColumnHashes[4] = keccak256(bytes("e")); // BigInt
        expectedColumnHashes[5] = keccak256(bytes("f")); // VarChar
        expectedColumnHashes[6] = keccak256(bytes("g")); // Decimal75
        expectedColumnHashes[7] = keccak256(bytes("h")); // TimestampTZ
        expectedColumnHashes[8] = keccak256(bytes("i")); // Scalar
        expectedColumnHashes[9] = keccak256(bytes("j")); // VarBinary
        assert(deserializedTableCommitment.columnNameHashes[0] == expectedColumnHashes[0]);
        assert(deserializedTableCommitment.columnNameHashes[1] == expectedColumnHashes[1]);
        assert(deserializedTableCommitment.columnNameHashes[2] == expectedColumnHashes[2]);
        assert(deserializedTableCommitment.columnNameHashes[3] == expectedColumnHashes[3]);
        assert(deserializedTableCommitment.columnNameHashes[4] == expectedColumnHashes[4]);
        assert(deserializedTableCommitment.columnNameHashes[5] == expectedColumnHashes[5]);
        assert(deserializedTableCommitment.columnNameHashes[6] == expectedColumnHashes[6]);
        assert(deserializedTableCommitment.columnNameHashes[7] == expectedColumnHashes[7]);
        assert(deserializedTableCommitment.columnNameHashes[8] == expectedColumnHashes[8]);
        assert(deserializedTableCommitment.columnNameHashes[9] == expectedColumnHashes[9]);
    }

    function testDeserializeTableCommitmentWithUnsupportedType() public {
        vm.expectRevert(Errors.TableCommitmentUnsupported.selector);
        VerifierTestWrapper.deserializeTableCommitment(
            hex"0000000000000000000000000000000300000000000000011a21982f135adddb079a91b739a8d358e47f38478eeaf8844c2f670f6595895e276a4c8714fba9d532e03556294ffdb2c6fb376a11ec2dda177a056e9513a28b0000000000000001000000000000000162000000000700000008"
        );

        vm.expectRevert(Errors.TableCommitmentUnsupported.selector);
        VerifierTestWrapper.deserializeTableCommitment(hex"0000000000000001");

        vm.expectRevert(Errors.TableCommitmentUnsupported.selector);
        VerifierTestWrapper.deserializeTableCommitment(
            hex"0000000000000000000000000000000000000000000000000000000000000001"
        );

        vm.expectRevert(Errors.TableCommitmentUnsupported.selector);
        VerifierTestWrapper.deserializeTableCommitment(
            hex"00000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000010001"
        );
    }

    function testPlan() public pure {
        bytes memory plan =
            hex"0000000000000001000000000000000f6e616d6573706163652e7461626c6500000000000000030000000000000000000000000000000162000000080a000000000000000000000000000000000163000000090000000100000000000000000000000000000000000000016100000005000000000000000200000000000000016200000000000000016300000000000000000000000000000002000000000000000000000002000000010000000500000000000000050000000000000002000000000000000000000000000000000000000000000001";
        VerifierTestWrapper.deserializeProofPlanPrefix(plan);
    }

    /// forge-config: default.allow_internal_expect_revert = true
    function testNotEnoughTableCommitments() public {
        uint64[] memory indices = new uint64[](1);
        indices[0] = 0;
        bytes32[] memory hashes = new bytes32[](1);
        hashes[0] = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;
        vm.expectRevert(Errors.CommitmentsNotFound.selector);
        Verifier.getRelevantCommitments(indices, hashes, new Verifier.TableCommitment[](0));
    }

    /// forge-config: default.allow_internal_expect_revert = true
    function testColumnHashesNotMatching() public {
        uint64[] memory indices = new uint64[](1);
        indices[0] = 0;
        bytes32[] memory hashes = new bytes32[](1);
        hashes[0] = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;
        Verifier.TableCommitment[] memory commitments = new Verifier.TableCommitment[](1);
        Verifier.TableCommitment memory first;
        bytes32[] memory firstHashes = new bytes32[](1);
        firstHashes[0] = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdee;
        first.columnNameHashes = firstHashes;
        first.tableLength = 1;
        first.commitmentsPtr = 1;
        commitments[0] = first;
        vm.expectRevert(Errors.CommitmentsNotFound.selector);
        Verifier.getRelevantCommitments(indices, hashes, commitments);
    }
}

library VerifierTestWrapper {
    function deserializeProofPlanPrefix(bytes calldata plan)
        external
        pure
        returns (
            // tableNameHashes[tableId] = tableNameHash
            bytes32[] memory tableNameHashes,
            // columnTableIndexes[columnId] = tableId
            uint64[] memory columnTableIndexes,
            // columnNameHashes[columnId] = columnNameHash
            bytes32[] memory columnNameHashes
        )
    {
        (tableNameHashes, columnTableIndexes, columnNameHashes) = Verifier.deserializeProofPlanPrefix(plan);
    }

    function deserializeTableCommitment(bytes calldata tableCommitment)
        external
        pure
        returns (Verifier.TableCommitment memory result)
    {
        result = Verifier.deserializeTableCommitment(tableCommitment);
    }

    function deserializeTableCommitments(bytes[] calldata tableCommitments)
        external
        pure
        returns (
            // tableCommitments[tableId] = TableCommitment
            Verifier.TableCommitment[] memory result
        )
    {
        result = Verifier.deserializeTableCommitments(tableCommitments);
    }
}
